CREATE TABLE Users (
    Id UNIQUEIDENTIFIER NOT NULL 
        CONSTRAINT PK_Users PRIMARY KEY DEFAULT NEWID(),

    Username NVARCHAR(50) NOT NULL,
    Email NVARCHAR(255) NOT NULL,

    PasswordHash NVARCHAR(500) NOT NULL,

    IsActive BIT NOT NULL DEFAULT 1,
    IsLocked BIT NOT NULL DEFAULT 0,
    EmailConfirmed BIT NOT NULL DEFAULT 0,

    CreatedAt DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    UpdatedAt DATETIME2 NULL,
    LastLoginAt DATETIME2 NULL,

    CONSTRAINT UQ_Users_Username UNIQUE (Username),
    CONSTRAINT UQ_Users_Email UNIQUE (Email)
);
CREATE TABLE Roles (
    Id UNIQUEIDENTIFIER NOT NULL 
        CONSTRAINT PK_Roles PRIMARY KEY DEFAULT NEWID(),

    Code NVARCHAR(50) NOT NULL,
    Name NVARCHAR(100) NOT NULL,
    Description NVARCHAR(255) NULL,

    CONSTRAINT UQ_Roles_Code UNIQUE (Code)
);


CREATE TABLE UserRoles (
    UserId UNIQUEIDENTIFIER NOT NULL,
    RoleId UNIQUEIDENTIFIER NOT NULL,

    AssignedAt DATETIME2 NOT NULL DEFAULT SYSDATETIME(),

    CONSTRAINT PK_UserRoles PRIMARY KEY (UserId, RoleId),
    CONSTRAINT FK_UserRoles_User FOREIGN KEY (UserId) REFERENCES Users(Id),
    CONSTRAINT FK_UserRoles_Role FOREIGN KEY (RoleId) REFERENCES Roles(Id)
);


CREATE TABLE Permissions (
    Id UNIQUEIDENTIFIER NOT NULL 
        CONSTRAINT PK_Permissions PRIMARY KEY DEFAULT NEWID(),

    Code NVARCHAR(100) NOT NULL,
    Name NVARCHAR(150) NOT NULL,
    Description NVARCHAR(255) NULL,

    CONSTRAINT UQ_Permissions_Code UNIQUE (Code)
);


CREATE TABLE RolePermissions (
    RoleId UNIQUEIDENTIFIER NOT NULL,
    PermissionId UNIQUEIDENTIFIER NOT NULL,

    CONSTRAINT PK_RolePermissions PRIMARY KEY (RoleId, PermissionId),
    CONSTRAINT FK_RolePermissions_Role FOREIGN KEY (RoleId) REFERENCES Roles(Id),
    CONSTRAINT FK_RolePermissions_Permission FOREIGN KEY (PermissionId) REFERENCES Permissions(Id)
);


CREATE TABLE RefreshTokens (
    Id UNIQUEIDENTIFIER NOT NULL 
        CONSTRAINT PK_RefreshTokens PRIMARY KEY DEFAULT NEWID(),

    UserId UNIQUEIDENTIFIER NOT NULL,
    Token NVARCHAR(500) NOT NULL,

    ExpiresAt DATETIME2 NOT NULL,
    RevokedAt DATETIME2 NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSDATETIME(),

    CONSTRAINT FK_RefreshTokens_User FOREIGN KEY (UserId) REFERENCES Users(Id)
);

CREATE TABLE LoginHistories (
    Id UNIQUEIDENTIFIER NOT NULL 
        CONSTRAINT PK_LoginHistories PRIMARY KEY DEFAULT NEWID(),

    UserId UNIQUEIDENTIFIER NOT NULL,
    LoginAt DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    IpAddress NVARCHAR(50) NULL,
    UserAgent NVARCHAR(255) NULL,
    IsSuccess BIT NOT NULL,

    CONSTRAINT FK_LoginHistories_User FOREIGN KEY (UserId) REFERENCES Users(Id)
);

CREATE TABLE UserClaims (
    Id UNIQUEIDENTIFIER NOT NULL 
        CONSTRAINT PK_UserClaims PRIMARY KEY DEFAULT NEWID(),

    UserId UNIQUEIDENTIFIER NOT NULL,
    ClaimType NVARCHAR(100) NOT NULL,
    ClaimValue NVARCHAR(255) NOT NULL,

    CONSTRAINT FK_UserClaims_User FOREIGN KEY (UserId) REFERENCES Users(Id)
);


	CREATE INDEX IX_Users_Email ON Users(Email);
	CREATE INDEX IX_Users_Username ON Users(Username);
	CREATE INDEX IX_RefreshTokens_UserId ON RefreshTokens(UserId);
	CREATE INDEX IX_LoginHistories_UserId ON LoginHistories(UserId);

